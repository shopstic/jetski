{
  "pin_ip_addresses.sh": "#!/usr/bin/env bash\n\nset -euo pipefail\n\narch=\"amd64\"\n\nif [[ \"$(uname -m)\" == \"aarch64\" ]]; then\n  arch=\"arm64\"\nfi\n\nwget -qO /usr/bin/yq https://github.com/mikefarah/yq/releases/download/v4.35.2/yq_linux_\"${arch}\"\n\nchmod +x /usr/bin/yq\n\nreadarray ifaces < <(yq -o=j -I=0 '.network.ethernets | to_entries | .[]' /etc/netplan/50-cloud-init.yaml)\n\ndeclare -p ifaces\n\nmkdir -p /etc/netplan\n\ncat >/etc/netplan/99-netcfg-static.yaml <<EOF\nnetwork:\n  version: 2\n  ethernets:\nEOF\n\nlastIp=\"\"\nlastIface=\"\"\nlastName=\"\"\n\nfor iface in \"${ifaces[@]}\"; do\n  lastName=$(echo \"$iface\" | yq '.key' -) || exit $?\n  mac=$(echo \"$iface\" | yq '.value.match.macaddress' -) || exit $?\n  lastIface=$(ip -br link | awk -v mac=\"$mac\" '$3 ~ mac { print $1 }') || exit $?\n  lastIp=$(wait_for_interface.sh \"$lastIface\") || exit $?\n\n  {\n    echo \"    ${lastName}:\"\n    echo \"      addresses:\"\n    echo \"        - ${lastIp}\"\n  } >>/etc/netplan/99-netcfg-static.yaml\ndone\n\necho \"$lastIface\" >/etc/node-external-iface\necho \"$lastIp\" | awk -F/ '{print $1}' >/etc/node-external-ip\ncat /etc/netplan/99-netcfg-static.yaml\nnetplan apply\n\necho \"Waiting for network to come back up...\"\n\nwhile ! ping -c 1 -W 1 8.8.8.8; do\n  sleep 1\n  echo \"Still waiting for network to come back up...\"\ndone\n",
  "wait_for_interface.sh": "#!/usr/bin/env bash\n\nset -euo pipefail\n\ninterface=${1:?\"Interface name is required\"}\n\nmaxAttempts=15\n\nattempts=0\n\nwhile ! ip addr show \"$interface\" | grep 'inet ' 1>&2; do\n  if [[ $attempts -ge $maxAttempts ]]; then\n    echo >&2 \"Timed out waiting for $interface to be up.\"\n    exit 1\n  fi\n\n  echo >&2 \"Waiting for $interface to be up...\"\n  sleep 1\n  attempts=$((attempts + 1))\ndone\n\nip addr show \"$interface\" | grep 'inet ' | awk '{print $2}'\n"
}
